# Reusable Elixir Release Workflow
# Usage: uses: agentjido/github-actions/.github/workflows/elixir-release.yml@main
#
# Requires: secrets: inherit in caller workflow
# Token: Uses GITHUB_TOKEN with contents:write permission
# If branch protection requires admin push, use a PAT instead

name: Elixir Release

on:
  workflow_call:
    inputs:
      otp_version:
        description: 'OTP version'
        required: false
        type: string
        default: '28'
      elixir_version:
        description: 'Elixir version'
        required: false
        type: string
        default: '1.18'
      mix_env:
        description: 'MIX_ENV for release'
        required: false
        type: string
        default: 'dev'
      release_command:
        description: 'Release command'
        required: false
        type: string
        default: 'mix git_ops.release --yes'
      dry_run:
        description: 'Dry run (no git push, no tag, no GitHub release, no Hex publish)'
        required: false
        type: boolean
        default: false
      hex_dry_run:
        description: 'Hex dry run only (run all git/release steps, but skip actual Hex publish)'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests before release'
        required: false
        type: boolean
        default: false

jobs:
  release:
    name: Release
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ github.token }}

      - name: Disable git hooks
        run: git config core.hooksPath /dev/null

      - name: Fetch tags
        run: |
          git fetch --tags --force
          echo "Available tags:"
          git tag -l | tail -10

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ inputs.otp_version }}
          elixir-version: ${{ inputs.elixir_version }}

      - name: Install Hex/Rebar
        run: |
          set -euo pipefail
          mix local.hex --force
          mix local.rebar --force

      - name: Restore Hex/Mix cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.hex
            ~/.mix
          key: ${{ runner.os }}-beamtools-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-beamtools-

      - name: Restore dependencies cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ inputs.mix_env }}-otp${{ inputs.otp_version }}-elixir${{ inputs.elixir_version }}-${{ hashFiles('mix.lock') }}

      - name: Remove cached rebar3 build artifacts in deps
        run: |
          if [ -d deps ]; then
            find deps -maxdepth 6 -type d \( -name _build -o -name .rebar3 \) -prune -exec rm -rf {} + || true
            find deps -maxdepth 6 -type f -name rebar3.crashdump -delete || true
          fi

      - name: Install dependencies
        run: |
          set -euo pipefail
          mix deps.get
          mix deps.compile
        env:
          MIX_ENV: ${{ inputs.mix_env }}

      - name: Run tests
        if: ${{ inputs.skip_tests != true }}
        run: |
          set -euo pipefail
          mix test

      - name: Run release
        id: release
        run: |
          set -euo pipefail
          # Check for releasable commits first (dry-run to detect "no changes")
          if ${{ inputs.release_command }} --dry-run 2>&1 | grep -qE "(No changes since|No changes should result)"; then
            echo "No releasable commits found since last release"
            echo "skipped=true" >> $GITHUB_OUTPUT
            echo "### Skipped: No releasable commits" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Run the actual release (no output capture to avoid exit code issues)
          ${{ inputs.release_command }}

          # Extract version from mix.exs after release (grep to avoid mix compilation output)
          VERSION="v$(grep -m1 '@version "' mix.exs | sed 's/.*"\(.*\)".*/\1/' || grep -m1 'version:' mix.exs | sed 's/.*"\(.*\)".*/\1/')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "skipped=false" >> $GITHUB_OUTPUT
          echo "### Version: $VERSION" >> "$GITHUB_STEP_SUMMARY"
        env:
          MIX_ENV: ${{ inputs.mix_env }}

      - name: Push changes and tags
        if: steps.release.outputs.skipped != 'true' && inputs.dry_run != true
        run: |
          set -euo pipefail
          git push origin HEAD
          git push origin --tags
          echo "Released version ${{ steps.release.outputs.version }}"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Publish to Hex.pm
        if: steps.release.outputs.skipped != 'true'
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: |
          set -euo pipefail
          if [ "${{ inputs.dry_run }}" = "true" ] || [ "${{ inputs.hex_dry_run }}" = "true" ]; then
            echo "### Hex Dry Run - Would publish:" >> "$GITHUB_STEP_SUMMARY"
            mix hex.publish --dry-run
          else
            mix hex.publish --yes
            echo "### Published to Hex.pm" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- Version: ${{ steps.release.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Create GitHub release
        if: steps.release.outputs.skipped != 'true' && inputs.dry_run != true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.release.outputs.version }}"
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes "See [CHANGELOG.md](CHANGELOG.md) for details."

      - name: Release summary
        run: |
          if [ "${{ steps.release.outputs.skipped }}" == "true" ]; then
            echo "::notice::No releasable commits found since last release"
          elif [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "::notice::Dry run completed for ${{ steps.release.outputs.version }}"
          else
            echo "::notice::Successfully released ${{ steps.release.outputs.version }}"
          fi
