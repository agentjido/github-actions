# Reusable Elixir Release Workflow
# Usage: uses: agentjido/github-actions/.github/workflows/elixir-release.yml@v1
#
# Requires: secrets: inherit in caller workflow
# Token: Uses GITHUB_TOKEN with contents:write permission
# If branch protection requires admin push, use a PAT instead

name: Elixir Release

on:
  workflow_call:
    inputs:
      otp_version:
        description: 'OTP version'
        required: false
        type: string
        default: '28'
      elixir_version:
        description: 'Elixir version'
        required: false
        type: string
        default: '1.18'
      mix_env:
        description: 'MIX_ENV for release'
        required: false
        type: string
        default: 'dev'
      release_command:
        description: 'Release command'
        required: false
        type: string
        default: 'mix git_ops.release --yes'

jobs:
  release:
    name: Release
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ inputs.otp_version }}
          elixir-version: ${{ inputs.elixir_version }}

      - name: Restore dependencies cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: |
            deps
            _build
            ~/.mix
            ~/.hex
          key: ${{ runner.os }}-mix-release-otp${{ inputs.otp_version }}-elixir${{ inputs.elixir_version }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-release-otp${{ inputs.otp_version }}-elixir${{ inputs.elixir_version }}-
            ${{ runner.os }}-mix-release-

      - name: Install dependencies
        run: mix deps.get
        env:
          MIX_ENV: ${{ inputs.mix_env }}

      - name: Compile
        run: mix compile
        env:
          MIX_ENV: ${{ inputs.mix_env }}

      - name: Run release
        id: release
        run: |
          OUTPUT=$(${{ inputs.release_command }} 2>&1) || {
            if echo "$OUTPUT" | grep -q "No changes since"; then
              echo "No releasable commits found since last release"
              echo "skipped=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "$OUTPUT"
            exit 1
          }
          echo "$OUTPUT"

          # Extract version from output
          VERSION=$(echo "$OUTPUT" | grep -oP 'v\d+\.\d+\.\d+' | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "skipped=false" >> $GITHUB_OUTPUT
        env:
          MIX_ENV: ${{ inputs.mix_env }}

      - name: Push changes and tags
        if: steps.release.outputs.skipped != 'true'
        run: |
          git push origin HEAD
          git push origin --tags
          echo "Released version ${{ steps.release.outputs.version }}"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Release summary
        run: |
          if [ "${{ steps.release.outputs.skipped }}" == "true" ]; then
            echo "::notice::No releasable commits found since last release"
          else
            echo "::notice::Successfully released ${{ steps.release.outputs.version }}"
          fi
